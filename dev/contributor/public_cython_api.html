
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Public Cython APIs &#8212; SciPy v1.7.0.dev0+1036.4ec6f29 Manual</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/scipy.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Adding New Methods, Functions, and Classes" href="adding_new.html" />
    <link rel="prev" title="Adding Cython to SciPy" href="cython.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../index.html">
  <img src="../../_static/scipyshiny_small.png" class="logo" alt="logo">
</a>      


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../getting_started.html">
  Getting started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../tutorial/index.html">
  User Guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../reference/index.html">
  API reference
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../index.html">
  Development
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../release.html">
  Release notes
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/scipy/scipy" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
    <p class="caption">
 <span class="caption-text">
  Contributing Information
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../conduct/code_of_conduct.html">
   SciPy Code of Conduct
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../hacking.html">
   Ways to Contribute
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="quickerstart_conda.html">
   Development environment quickerstart guide (Linux and Mac)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="contributor_toc.html">
   SciPy contributor guide
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Roadmap
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../roadmap.html">
   SciPy Roadmap
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../roadmap-detailed.html">
   Detailed SciPy Roadmap
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../toolchain.html">
   Toolchain Roadmap
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  SciPy Organization
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../core-dev/index.html">
   SciPy Core Developer Guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../api-dev/api-dev-toc.html">
   SciPy API Development Guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../governance/governance.html">
   SciPy Project Governance
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="quickstart_mac.html">
   Development environment quickstart guide (macOS)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="quickstart_ubuntu.html">
   Development environment quickstart guide (Ubuntu)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="development_workflow.html">
   Development workflow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="pep8.html">
   PEP8 and SciPy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="rendering_documentation.html">
   Rendering Documentation with Sphinx
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="runtests.html">
   Running SciPy Tests Locally
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="benchmarking.html">
   Benchmarking SciPy with airspeed velocity
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cython.html">
   Adding Cython to SciPy
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Public Cython APIs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="adding_new.html">
   Adding New Methods, Functions, and Classes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="continuous_integration.html">
   Continuous Integration
  </a>
 </li>
</ul>

    
  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#application-binary-interface">
   Application Binary Interface
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#abi-stability-aim">
   ABI stability aim
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#implementing-abi-stability-in-scipy">
   Implementing ABI stability in SciPy
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deprecating-public-cython-apis">
   Deprecating public Cython APIs
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="public-cython-apis">
<span id="public-cython-api"></span><h1>Public Cython APIs<a class="headerlink" href="#public-cython-apis" title="Permalink to this headline">¶</a></h1>
<p>As of Apr 2020, the following modules in SciPy expose functionality
via a public <code class="docutils literal notranslate"><span class="pre">cdef</span></code> Cython API declarations:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">scipy.linalg.cython_blas</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">scipy.linalg.cython_lapack</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">scipy.optimize.cython_optimize</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">scipy.special.cython_special</span></code></p></li>
</ul>
<p>This uses <a class="reference external" href="cython-sharing-declarations">Cython’s declaration sharing features</a>, where shared <code class="docutils literal notranslate"><span class="pre">cdef</span></code> items are
declared in <code class="docutils literal notranslate"><span class="pre">*.pxd</span></code> files that are distributed together with the
corresponding DLL/SO files in binary SciPy installations.</p>
<section id="application-binary-interface">
<h2>Application Binary Interface<a class="headerlink" href="#application-binary-interface" title="Permalink to this headline">¶</a></h2>
<p>Using these features in SciPy however requires SciPy contributors to
take additional care with regard to maintaining Application Binary
Interface (ABI) stability. This is similar to developing libraries in
C, and different from how backward compatibility works in pure Python.</p>
<p>The main difference to Python originates from the fact that the
declarations in the header <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> files are used when code written
by users is <em>compiled</em>, but they must also match with what is
available in SciPy when the user code is <em>imported</em>.</p>
<p>User code may be compiled with one version of SciPy, and the compiled
binary (which uses the binary interface declared in the <code class="docutils literal notranslate"><span class="pre">.pxd</span></code>
files) can be used with a different SciPy version installed on the
system. If the interfaces are not compatible, either an
exception is raised or runtime memory corruption and crash ensue.</p>
<p>At import time, Cython checks that signatures of functions in the
installed SciPy SO/DLL file match the one in the <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> file used by
the user during compilation, and raises a Python exception if there is
a mismatch.  If the SciPy code is structured correctly (see below),
this check is performed only for functions that are actually imported
in the user code.</p>
<p>We rely on this feature to provide a runtime safety check, which makes
it easier for the users to detect incompatible SciPy versions via
Python exceptions, instead of hard-to-trace runtime crashes.</p>
</section>
<section id="abi-stability-aim">
<h2>ABI stability aim<a class="headerlink" href="#abi-stability-aim" title="Permalink to this headline">¶</a></h2>
<p>SciPy aims to maintain ABI stability in Cython code, in the following
sense:</p>
<blockquote>
<div><p>Binaries produced by compiling user source with one version of
SciPy, are compatible with any other SciPy version with which the
source code can be compiled.</p>
<p>Trying to use an incompatible version of SciPy at runtime will
result in a Python exception at user module import time.</p>
<p>Trying to use an incompatible version of SciPy at compile time
will result in a Cython error.</p>
</div></blockquote>
<p>This means that users can use any compatible version of SciPy to
compile binaries without having to pay attention to ABI, i.e.,</p>
<blockquote>
<div><p>ABI compatibility = API compatibility</p>
</div></blockquote>
<p>Cython API backward/forward compatibility will be handled with a
similar deprecation/removal policy as for the Python API, see
<a class="reference internal" href="../core-dev/index.html#deprecations"><span class="std std-ref">Deprecations</span></a>.</p>
</section>
<section id="implementing-abi-stability-in-scipy">
<h2>Implementing ABI stability in SciPy<a class="headerlink" href="#implementing-abi-stability-in-scipy" title="Permalink to this headline">¶</a></h2>
<p>The following rules in development of Cython APIs in SciPy are
necessary to maintain the ABI stability aim above:</p>
<ul>
<li><p>Adding new <code class="docutils literal notranslate"><span class="pre">cdef</span></code> declarations (functions, structs, types, etc.)
<strong>is allowed</strong>.</p></li>
<li><p>Removing <code class="docutils literal notranslate"><span class="pre">cdef</span></code> declarations <strong>is allowed</strong>, but <strong>should follow</strong>
general deprecation/removal policy.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cdef</span></code> declarations of functions <strong>may be changed</strong>.</p>
<p>However, changes result in a backward incompatible API change which
breaks any code using the changed signature, and <strong>should follow</strong>
general deprecation/removal policy.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">cdef</span></code> declarations of anything else (e.g. <code class="docutils literal notranslate"><span class="pre">struct</span></code>, <code class="docutils literal notranslate"><span class="pre">enum</span></code>,
and types) are <strong>final</strong>.  Once a declaration is exposed in the
public Cython API in a released SciPy version, <strong>it must not be
changed</strong>.</p>
<p>If changes are necessary, they need to be carried out by adding
new declarations with different names, and removing old ones.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">cdef</span></code> classes are <strong>not allowed</strong> in the public APIs (TBD:
backward compatibility of cdef classes needs more research, but must
not be allowed when we are not sure)</p></li>
<li><p>For each public API module (as in <code class="docutils literal notranslate"><span class="pre">scipy.linalg.cython_blas</span></code>), use
a single interface <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> declaration file.</p>
<p>The public interface declaration file <strong>should not</strong> contain
<code class="docutils literal notranslate"><span class="pre">cimport</span></code> statements.  If it does, Cython’s signature check will
check all of the cimported functions, not only the ones that are
used by user code, so that changing one of them breaks the whole
API.</p>
</li>
<li><p>If data structures are necessary, <strong>prefer opaque structs</strong> in the
public API.  The interface declarations should not contain any
declarations of struct members.  Allocation, freeing, and attribute
access of data structures should be done with functions.</p></li>
</ul>
</section>
<section id="deprecating-public-cython-apis">
<span id="deprecating-public-cython-api"></span><h2>Deprecating public Cython APIs<a class="headerlink" href="#deprecating-public-cython-apis" title="Permalink to this headline">¶</a></h2>
<p>To deprecate a public Cython API function, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># scipy/something/foo.pxd</span>
<span class="n">cdef</span> <span class="n">public</span> <span class="nb">int</span> <span class="n">somefunc</span><span class="p">()</span>

<span class="c1"># scipy/something/foo.pyx</span>
<span class="n">cdef</span> <span class="n">public</span> <span class="nb">int</span> <span class="n">somefunc</span><span class="p">():</span>
    <span class="k">return</span> <span class="mi">42</span>
</pre></div>
</div>
<p>you can add use the <code class="docutils literal notranslate"><span class="pre">scipy._lib.deprecation.deprecate_cython_api</span></code>
function to do the deprecations at the end of the corresponding
<code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># scipy/something/foo.pyx</span>
<span class="n">cdef</span> <span class="n">public</span> <span class="nb">int</span> <span class="n">somefunc</span><span class="p">():</span>
    <span class="k">return</span> <span class="mi">42</span>

<span class="kn">from</span> <span class="nn">scipy._lib.deprecation</span> <span class="kn">import</span> <span class="n">deprecate_cython_api</span>
<span class="kn">import</span> <span class="nn">scipy.something.foo</span> <span class="k">as</span> <span class="nn">mod</span>
<span class="n">deprecate_cython_api</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s2">&quot;somefunc&quot;</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="s2">&quot;scipy.something.newfunc&quot;</span><span class="p">,</span>
                     <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Deprecated in Scipy 1.5.0&quot;</span><span class="p">)</span>
<span class="k">del</span> <span class="n">deprecate_cython_api</span><span class="p">,</span> <span class="n">mod</span>
</pre></div>
</div>
<p>After this, Cython modules that <code class="docutils literal notranslate"><span class="pre">cimport</span> <span class="pre">somefunc</span></code>, will emit a
<em class="xref py py-obj">DeprecationWarning</em> at import time.</p>
<p>There is no way to deprecate Cython data structures and types.  They
can be however removed after all functions using them in the API are
removed, having gone through the deprecation cycle.</p>
<p>Whole Cython modules can be deprecated similarly as Python modules, by
emitting a <em class="xref py py-obj">DeprecationWarning</em> on the top-level.</p>
</section>
</section>


              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="cython.html" title="previous page">Adding Cython to SciPy</a>
    <a class='right-next' id="next-link" href="adding_new.html" title="next page">Adding New Methods, Functions, and Classes</a>

              </div>
              
          </main>
          

      </div>
    </div>
  
  <script src="../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2008-2021, The SciPy community.<br/>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.0.2.<br/>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>