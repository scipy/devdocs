
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Adding Cython to SciPy &#8212; SciPy v1.7.0.dev0+1036.4ec6f29 Manual</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/scipy.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Public Cython APIs" href="public_cython_api.html" />
    <link rel="prev" title="Benchmarking SciPy with airspeed velocity" href="benchmarking.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../index.html">
  <img src="../../_static/scipyshiny_small.png" class="logo" alt="logo">
</a>      


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../getting_started.html">
  Getting started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../tutorial/index.html">
  User Guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../reference/index.html">
  API reference
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../index.html">
  Development
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../release.html">
  Release notes
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/scipy/scipy" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
    <p class="caption">
 <span class="caption-text">
  Contributing Information
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../conduct/code_of_conduct.html">
   SciPy Code of Conduct
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../hacking.html">
   Ways to Contribute
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="quickerstart_conda.html">
   Development environment quickerstart guide (Linux and Mac)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="contributor_toc.html">
   SciPy contributor guide
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Roadmap
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../roadmap.html">
   SciPy Roadmap
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../roadmap-detailed.html">
   Detailed SciPy Roadmap
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../toolchain.html">
   Toolchain Roadmap
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  SciPy Organization
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../core-dev/index.html">
   SciPy Core Developer Guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../api-dev/api-dev-toc.html">
   SciPy API Development Guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../governance/governance.html">
   SciPy Project Governance
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="quickstart_mac.html">
   Development environment quickstart guide (macOS)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="quickstart_ubuntu.html">
   Development environment quickstart guide (Ubuntu)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="development_workflow.html">
   Development workflow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="pep8.html">
   PEP8 and SciPy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="rendering_documentation.html">
   Rendering Documentation with Sphinx
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="runtests.html">
   Running SciPy Tests Locally
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="benchmarking.html">
   Benchmarking SciPy with airspeed velocity
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Adding Cython to SciPy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="public_cython_api.html">
   Public Cython APIs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="adding_new.html">
   Adding New Methods, Functions, and Classes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="continuous_integration.html">
   Continuous Integration
  </a>
 </li>
</ul>

    
  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example">
   Example
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercise">
   Exercise
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="adding-cython-to-scipy">
<span id="adding-cython"></span><h1>Adding Cython to SciPy<a class="headerlink" href="#adding-cython-to-scipy" title="Permalink to this headline">¶</a></h1>
<p>As written on the <a class="reference external" href="https://cython.org/">Cython website</a>:</p>
<blockquote>
<div><p>Cython is an optimising static
compiler for both the Python programming language and the extended
Cython programming language (based on Pyrex). It makes writing C
extensions for Python as easy as Python itself.</p>
</div></blockquote>
<p>If your code currently performs a lot of loops in Python, it might
benefit from compilation with Cython. This document is intended to be a
very brief introduction: just enough to see how to use Cython with
SciPy. Once you have your code compiling, you can learn more about how
to optimize it by reviewing the <a class="reference external" href="http://docs.cython.org/en/latest/">Cython documentation</a>.</p>
<p>There are only two things you need to do in order for SciPy compile your
code with Cython:</p>
<ol class="arabic simple">
<li><p>Include your code in a file with a <code class="docutils literal notranslate"><span class="pre">.pyx</span></code>
extension rather than a <code class="docutils literal notranslate"><span class="pre">.py</span></code> extension. All files with a <code class="docutils literal notranslate"><span class="pre">.pyx</span></code>
extension are automatically converted by Cython to <code class="docutils literal notranslate"><span class="pre">.c</span></code> files when
SciPy is built.</p></li>
<li><p>Add an extension from this <code class="docutils literal notranslate"><span class="pre">.c</span></code> file to the
configuration of the subpackage in which your code lives. Typically,
this is very easy: add a single, formulaic line to the subpackage’s
<code class="docutils literal notranslate"><span class="pre">setup.py</span></code> file. Once added as an extension, the <code class="docutils literal notranslate"><span class="pre">.c</span></code> code will be
compiled by your C compiler to machine code when SciPy is built.</p></li>
</ol>
<section id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/scipy/scipy/blob/master/scipy/optimize/_linprog_rs.py"><code class="docutils literal notranslate"><span class="pre">scipy.optimize._linprog_rs.py</span></code></a> contains the implementation of the
revised simplex method for <code class="docutils literal notranslate"><span class="pre">scipy.optimize.linprog</span></code>. The revised
simplex method performs many elementary row operations on matrices, and
so it was a natural candidate to be Cythonized.</p>
<p>Note that <code class="docutils literal notranslate"><span class="pre">scipy/optimize/_linprog_rs.py</span></code> imports the <code class="docutils literal notranslate"><span class="pre">BGLU</span></code> and
<code class="docutils literal notranslate"><span class="pre">LU</span></code> classes from <code class="docutils literal notranslate"><span class="pre">._bglu_dense</span></code> exactly as if they were regular
Python classes. But they’re not. <code class="docutils literal notranslate"><span class="pre">BGLU</span></code> and <code class="docutils literal notranslate"><span class="pre">LU</span></code> are Cython classes
defined in <a class="reference external" href="https://github.com/scipy/scipy/blob/master/scipy/optimize/_bglu_dense.pyx"><code class="docutils literal notranslate"><span class="pre">/scipy/optimize/_bglu_dense.pyx</span></code></a>. There is nothing
about the way they are imported or used that suggests that they are
written in Cython; the only way so far that we can tell they are Cython
classes is that they are defined in a file with a <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> extension.</p>
<p>Even in <code class="docutils literal notranslate"><span class="pre">/scipy/optimize/_bglu_dense.pyx</span></code>, most of the code resembles
Python. The most notable differences are the presence of <a class="reference external" href="https://cython.readthedocs.io/en/latest/src/userguide/sharing_declarations.html"><code class="docutils literal notranslate"><span class="pre">cimport</span></code></a>,
<a class="reference external" href="https://github.com/scipy/scipy/blob/master/scipy/optimize/setup.py"><code class="docutils literal notranslate"><span class="pre">cdef</span></code></a>, and <a class="reference external" href="https://cython.readthedocs.io/en/latest/src/userguide/numpy_tutorial.html">Cython decorators</a>. None of these are strictly
necessary. Without them, the pure Python code can still be compiled by
Cython. The Cython language extensions are *just* tweaks to improve
performance. This <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file is automatically converted to a <code class="docutils literal notranslate"><span class="pre">.c</span></code>
file by Cython when SciPy is built.</p>
<p>The only thing left is to add an extension from this <code class="docutils literal notranslate"><span class="pre">.c</span></code> file using
<a class="reference external" href="https://docs.scipy.org/doc/numpy/reference/distutils.html"><code class="docutils literal notranslate"><span class="pre">numpy.distutils</span></code></a>. This takes just a single line in <a class="reference external" href="https://github.com/scipy/scipy/blob/master/scipy/optimize/setup.py"><code class="docutils literal notranslate"><span class="pre">scipy/optimize/setup.py</span></code></a>:
<code class="docutils literal notranslate"><span class="pre">config.add_extension('_bglu_dense',</span> <span class="pre">sources=['_bglu_dense.c'])</span></code>,
<code class="docutils literal notranslate"><span class="pre">_bglu_dense.c</span></code> is the source and <code class="docutils literal notranslate"><span class="pre">_bglu_dense</span></code> is the name of the
extension (for consistency). When SciPy is built, <code class="docutils literal notranslate"><span class="pre">_bglu_dense.c</span></code> will
be compiled to machine code, and we will be able to import the <code class="docutils literal notranslate"><span class="pre">LU</span></code>
and <code class="docutils literal notranslate"><span class="pre">BGLU</span></code> classes from the extension <code class="docutils literal notranslate"><span class="pre">_bglu_dense</span></code>.</p>
</section>
<section id="exercise">
<h2>Exercise<a class="headerlink" href="#exercise" title="Permalink to this headline">¶</a></h2>
<p><em>See a video run-through of this exercise:</em> <a class="reference external" href="https://youtu.be/K9bF7cjUJ7c">Cythonizing SciPy Code</a> </p>
<ol class="arabic">
<li><p>Update Cython and create a new branch
(e.g., <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">checkout</span> <span class="pre">-b</span> <span class="pre">cython_test</span></code>) in which to make some
experimental changes to SciPy</p></li>
<li><p>Add some simple Python code in a <code class="docutils literal notranslate"><span class="pre">.py</span></code> file in the
<code class="docutils literal notranslate"><span class="pre">/scipy/optimize</span></code> directory, say <code class="docutils literal notranslate"><span class="pre">/scipy/optimize/mypython.py</span></code>.
For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">myfun</span><span class="p">():</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000000</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">i</span>
</pre></div>
</div>
</li>
<li><p>Let’s see how long this pure-Python loop takes so we can compare the
performance of Cython. For example, in an IPython console in Spyder:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.optimize.mypython</span> <span class="kn">import</span> <span class="n">myfun</span>
<span class="o">%</span><span class="n">timeit</span> <span class="n">myfun</span><span class="p">()</span>
</pre></div>
</div>
<p>I get something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>715 ms ± 10.7 ms per loop
</pre></div>
</div>
</li>
<li><p>Save your <code class="docutils literal notranslate"><span class="pre">.py</span></code> file to a <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file, e.g. <code class="docutils literal notranslate"><span class="pre">mycython.pyx</span></code>.</p></li>
<li><p>Build SciPy. Note that a <code class="docutils literal notranslate"><span class="pre">.c</span></code> file has been added to the
<code class="docutils literal notranslate"><span class="pre">/scipy/optimize</span></code> directory.</p></li>
<li><p>Somewhere near similar lines, add an extension from your <code class="docutils literal notranslate"><span class="pre">.c</span></code> file
to <code class="docutils literal notranslate"><span class="pre">/scipy/optimize/setup.py</span></code>. e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="o">.</span><span class="n">add_extension</span><span class="p">(</span><span class="s1">&#39;_group_columns&#39;</span><span class="p">,</span> <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;_group_columns.c&#39;</span><span class="p">],)</span>  <span class="c1"># was already here</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_extension</span><span class="p">(</span><span class="s1">&#39;mycython&#39;</span><span class="p">,</span> <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mycython.c&#39;</span><span class="p">],)</span>  <span class="c1"># this was new</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_extension</span><span class="p">(</span><span class="s1">&#39;_bglu_dense&#39;</span><span class="p">,</span> <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;_bglu_dense.c&#39;</span><span class="p">])</span>  <span class="c1"># was already there</span>
</pre></div>
</div>
</li>
<li><p>Rebuild SciPy. Note that a <code class="docutils literal notranslate"><span class="pre">.so</span></code> file has been added to the
<code class="docutils literal notranslate"><span class="pre">/scipy/optimize</span></code> directory.</p></li>
<li><p>Time it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.optimize.mycython</span> <span class="kn">import</span> <span class="n">myfun</span>
<span class="o">%</span><span class="n">timeit</span> <span class="n">myfun</span><span class="p">()</span>
</pre></div>
</div>
<p>I get something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>359 ms ± 6.98 ms per loop
</pre></div>
</div>
<p>Cython sped up the pure Python code by a factor of ~2.</p>
</li>
<li><p>That’s not much of an improvement in the scheme of things. To see
why, it helps to have Cython create an “annotated” version of our
code to show bottlenecks. In a terminal window, call Cython on your
<code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file with the <code class="docutils literal notranslate"><span class="pre">-a</span></code> flag:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cython</span> <span class="o">-</span><span class="n">a</span> <span class="n">scipy</span><span class="o">/</span><span class="n">optimize</span><span class="o">/</span><span class="n">mycython</span><span class="o">.</span><span class="n">pyx</span>
</pre></div>
</div>
<p>Note that this creates a new <code class="docutils literal notranslate"><span class="pre">.html</span></code> file in the
<code class="docutils literal notranslate"><span class="pre">/scipy/optimize</span></code> directory. Open the <code class="docutils literal notranslate"><span class="pre">.html</span></code> file in any
browser.</p>
</li>
<li><p>The yellow-highlighted lines in the file indicate potential
interaction between the compiled code and Python, which slows things
down considerably. The intensity of the highlighting indicates the
estimated severity of the interaction. In this case, much of the
interaction can be avoided if we define the variable <code class="docutils literal notranslate"><span class="pre">i</span></code> as an
integer so that Cython doesn’t have to consider the possibility of
it being a general Python object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">myfun</span><span class="p">():</span>
    <span class="n">cdef</span> <span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># our first line of Cython code</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000000</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">i</span>
</pre></div>
</div>
<p>Recreating the annotated <code class="docutils literal notranslate"><span class="pre">.html</span></code> file shows that most of the
Python interaction has disappeared.</p>
</li>
<li><p>Rebuild SciPy, open an fresh IPython console, and <code class="docutils literal notranslate"><span class="pre">%timeit</span></code>:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.optimize.mycython</span> <span class="kn">import</span> <span class="n">myfun</span>
<span class="o">%</span><span class="n">timeit</span> <span class="n">myfun</span><span class="p">()</span>
</pre></div>
</div>
<p>I get something like: <code class="docutils literal notranslate"><span class="pre">68.6</span> <span class="pre">ns</span> <span class="pre">±</span> <span class="pre">1.95</span> <span class="pre">ns</span> <span class="pre">per</span> <span class="pre">loop</span></code>. The Cython code ran
about 10 million times faster than the original Python code.</p>
<p>In this case, the compiler probably optimized away the loop, simply
returning the final result. This sort of speedup is not typical for real
code, but this exercise certainly illustrates the power of Cython when
the alternative is many low-level operations in Python.</p>
</section>
</section>


              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="benchmarking.html" title="previous page">Benchmarking SciPy with airspeed velocity</a>
    <a class='right-next' id="next-link" href="public_cython_api.html" title="next page">Public Cython APIs</a>

              </div>
              
          </main>
          

      </div>
    </div>
  
  <script src="../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2008-2021, The SciPy community.<br/>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.0.2.<br/>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>